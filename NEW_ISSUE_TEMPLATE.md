# New Issue Template for Playwright

**Copy and paste this into a new GitHub issue at:** https://github.com/microsoft/playwright/issues/new/choose
**Choose:** "Bug Report" template

---

## ðŸ› Bug Report

### Description
Playwright 1.58.0 incorrectly collects `*.esm.preflight` files as test files when using `tsx/esm` in the configuration, causing duplicate test title errors. This is a regression from version 1.57.0.

### Playwright Version
1.58.0

### Operating System
macOS 26.2 (arm64)

### Node.js Version
22.19.0

### Browser
Chromium

### Steps to Reproduce

1. Create a TypeScript ESM project with `"type": "module"` in package.json
2. Install `@playwright/test@1.58.0` and `tsx@4.21.0`
3. Import `tsx/esm` in `playwright.config.ts`:
   ```typescript
   import { defineConfig } from "@playwright/test";
   import "tsx/esm";

   export default defineConfig({
     testDir: "./tests",
     build: { external: ["*"] },
   });
   ```
4. Create any test file (e.g., `tests/example.spec.ts`)
5. Run `npx playwright test`

**Minimal Reproduction Repository:**
[Upload the /tmp/playwright-esm-preflight-bug folder to GitHub and add link here]

Or run these commands to reproduce locally:
```bash
mkdir playwright-bug-repro && cd playwright-bug-repro
npm init -y
npm pkg set type=module
npm install -D @playwright/test@1.58.0 tsx@4.21.0
mkdir tests
```

Create `playwright.config.ts`:
```typescript
import { defineConfig } from "@playwright/test";
import "tsx/esm";

export default defineConfig({
  testDir: "./tests",
  build: { external: ["*"] },
});
```

Create `tests/example.spec.ts`:
```typescript
import { test, expect } from "@playwright/test";

test("example test", async ({ page }) => {
  await page.goto("https://example.com");
  await expect(page).toHaveTitle(/Example/);
});
```

Then run:
```bash
npx playwright install chromium
npx playwright test
```

### Expected Behavior
Playwright should only collect and execute tests from `*.spec.ts` files (or other configured test file patterns). No `*.esm.preflight` files should be involved.

### Actual Behavior
Playwright reports duplicate test title errors, referencing non-existent `*.esm.preflight` files:

```
Error: duplicate test title "example test", first declared in example.spec.ts.esm.preflight:3
   at example.spec.ts:1

> 1 | import { test, expect } from "@playwright/test";
    |                                           ^
  2 |
  3 | test("example test", async ({ page }) => {
  4 |   await page.goto("https://example.com");
```

These `.esm.preflight` files don't exist in the repository but appear to be created by the `tsx/esm` loader and are being incorrectly collected as test files by Playwright.

### Environment Info
```
  System:
    OS: macOS 26.2
    CPU: (8) arm64 Apple M3
    Memory: 92.39 MB / 8.00 GB
  Binaries:
    Node: 22.19.0 - ~/.nvm/versions/node/v22.19.0/bin/node
    npm: 11.6.4 - ~/.nvm/versions/node/v22.19.0/bin/npm
  npmPackages:
    @playwright/test: 1.58.0
    tsx: 4.21.0
```

### Additional Context

- **Regression**: This works correctly in Playwright 1.57.0
- **Workaround**: Downgrade to `@playwright/test@1.57.0`
- **Real-world impact**: This is blocking upgrades in production projects, such as [Aam-Digital/ndb-core](https://github.com/Aam-Digital/ndb-core)
- **Original issue**: #39028 (closed, requesting proper repro)

The `.esm.preflight` files appear to be generated by tsx's ESM loader transformation but should be excluded from Playwright's test file collection pattern.
